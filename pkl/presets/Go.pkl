module com.farthergate.goldberg.presets.Go

import "../Config.pkl"

function assets(exe: String, archs: Listing<String>, oss: Listing<String>) = new Listing<String> {
  for (arch in archs) {
    for (os in oss) {
      exe + "-" + os + "-" + arch
    }
  }
}

local function build(exe: String, entry: String, archs: Listing<String>, oss: Listing<String>) = new Config
  .Step {
  name = "build"
  commands {
    for (arch in archs) {
      for (os in oss) {
        new {
          "env"
          "GOOS=" + os
          "GOARCH=" + arch
          "go"
          "build"
          "-o"
          exe + "-" + os + "-" + arch
          entry
        }
      }
    }
  }
}

defaultArch = new Listing<String> { "amd64"; "arm64" }
defaultOS = new Listing<String> { "linux"; "windows"; "darwin"; "freebsd" }

function preset(exe: String, entry: String, archs: Listing<String>, oss: Listing<String>) = new Config
  .Preset {
  name = "go"
  defaultSteps {
    build(exe, entry, archs, oss)
  }
}
