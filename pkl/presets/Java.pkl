module com.farthergate.goldberg.presets.Java

import "../Config.pkl"

function makeJarExecutable(jar: String, mainClass: String, outFile: String) = new Config.Preset {
  name = "java:make-exe"
  defaultSteps {
    new {
      name = "java:make-exe"
      commands {
        new { "bash"; "build-aux/java/make-executable-jar.sh"; jar; outFile }
      }
      resources {
        ["java/make-executable-jar.sh"] =
          #"""
          #!/usr/bin/env bash

          # based on https://mill-build.org/blog/5-executable-jars.html

          JAVA_OPTS="--sun-misc-unsafe-memory-access=allow --enable-native-access=ALL-UNNAMED"

          cat > $2 <<EOF
          @ 2>/dev/null # 2>nul & echo off & goto BOF
          :
          exec java $JAVA_OPTS  \$JAVA_OPTS -cp "\$0" '
          """#
            + mainClass
            + #"""
            ' "\$@"
            exit

            :BOF
            setlocal
            @echo off
            java $JAVA_OPTS %JAVA_OPTS% -cp "%~dpnx0"
            """#
            + " "
            + mainClass
            + #"""
             %*
            endlocal
            exit /B %errorlevel%
            EOF

            cat $1 >> $2
            chmod +x $2
            """#
      }
    }
  }
}
