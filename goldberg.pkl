amends "./pkl/Config.pkl"
import "https://cache.farthergate.com/Cache.pkl"

import "./pkl/presets/Files.pkl"
import "./pkl/presets/Forester.pkl"
import "./pkl/presets/Java.pkl"
import "./pkl/presets/Maven.pkl"
import "./pkl/presets/Pkldoc.pkl"
import "./pkl/release/SourceHut.pkl"

name = "goldberg"
version = "0.4.1"

local buildDocs = new Listing {
  Pkldoc.build("pkl", "docs/output/docs")
  Forester.build("docs/forest.toml")
  Files.copy("pkl", "docs/output")
}

local buildExe = new Listing {
  Maven.package(true)
  Java.makeJarExecutable("target/" + module.versionedName + ".jar", module.versionedName)
}

use {
  outer.single(
    outer.command(Cache.install(new Listing { "pkldoc"; "forester" }).defaultSteps[0].commands[0]),
  )

  ...buildDocs
  SourceHut.deployPages("docs/output", "goldberg.farthergate.com")

  ...buildExe
  SourceHut.release(
    source,
    new Listing { module.versionedName },
    "v" + version,
  )
}

tasks {
  ["docs"] = buildDocs
  ["exe"] = buildExe
}

source {
  repo = "goldberg"
}

ci {
  oauth {
    "git.sr.ht/OBJECTS:RW"
    "git.sr.ht/PROFILE:RO"
    "git.sr.ht/REPOSITORIES:RO"
    "pages.sr.ht/PAGES:RW"
  }
  environment {
    ["CLICOLOR_FORCE"] = "always"
  }
}
