amends "./pkl/Config.pkl"
import "https://cache.farthergate.com/Cache.pkl"
import "https://git.sr.ht/~aleksrutins/forester-theme/blob/main/Theme.pkl"

import "./pkl/presets/Files.pkl"
import "./pkl/presets/Forester.pkl"
import "./pkl/presets/Gradle.pkl"
import "./pkl/presets/Java.pkl"
import "./pkl/presets/Pkldoc.pkl"
import "./pkl/release/SourceHut.pkl"

name = "goldberg"
version = "0.5.0"

local buildDocs = new Listing {
  module.single(new Step {
    name = "theme:install"
    commands = Theme.install.defaultSteps[0].commands
  })
  Files.copy("theme", "docs/theme")
  Pkldoc.build("pkl", "docs/output/docs")
  Forester.build("docs/forest.toml")
  Files.copy("pkl", "docs/output")
}

local buildExe = new Listing {
  Gradle.task("fatJar", true)
  Java.makeJarExecutable(
    "build/libs/" + module.versionedName + "-standalone.jar",
    "com.farthergate.AppKt",
    module.versionedName,
  )
}

use {
  outer.single(outer.command(Cache.install(new Listing { "forester" }).defaultSteps[0].commands[0]))

  ...buildDocs
  SourceHut.deployPages("docs/output", "goldberg.farthergate.com")

  ...buildExe
  SourceHut.release(
    source,
    new Listing { module.versionedName },
    "v" + version,
  )
}

tasks {
  ["docs"] = buildDocs
  ["exe"] = buildExe
}

source {
  repo = "goldberg"
}

ci {
  oauth {
    "git.sr.ht/OBJECTS:RW"
    "git.sr.ht/PROFILE:RO"
    "git.sr.ht/REPOSITORIES:RO"
    "pages.sr.ht/PAGES:RW"
  }
  environment {
    ["CLICOLOR_FORCE"] = "always"
  }
}
